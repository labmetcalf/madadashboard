---
title: "COVID-19 | Madagascar"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: [ "twitter", "facebook", "menu" ]
    vertical_layout: scroll
    theme: bootstrap
    navbar:
      - { title: "<img style=\"width: 16px;\" src=\"www/us16.png\" />   English", href: "index.html"}
     
params:
  lang: "MDG"
---

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-N9D53DP');</script>
<!-- End Google Tag Manager -->

```{r setup, include=FALSE}
library(flexdashboard)
library(googlesheets4)
library(shiny)
library(sf)
library(leaflet)
library(tidyverse)
library(plotly)
library(lubridate)
library(dygraphs)
library(zoo)
library(forecast)
library(stringdist)
library(glue)
```


```{r}
# pull data from google sheets & clean
gs4_deauth()
data   <- read_sheet("https://docs.google.com/spreadsheets/d/1oQJl4HiTviKAAhCjMmg0ipGcO79cZg6gSHrdTuQID_w/edit#gid=0", sheet = 2)
test   <- read_sheet("https://docs.google.com/spreadsheets/d/1oQJl4HiTviKAAhCjMmg0ipGcO79cZg6gSHrdTuQID_w/edit#gid=0", sheet = 3)
events <- read_sheet("https://docs.google.com/spreadsheets/d/1oQJl4HiTviKAAhCjMmg0ipGcO79cZg6gSHrdTuQID_w/edit#gid=0", sheet = 5)
text   <- read_sheet("https://docs.google.com/spreadsheets/d/1oQJl4HiTviKAAhCjMmg0ipGcO79cZg6gSHrdTuQID_w/edit#gid=0", sheet = 6)

# shapefiles
mdg2 <- read_sf("data/regions/MDG_ADM1.shp")

# Cases by region
data$region<-mdg2$NAME[amatch(data$Location4,mdg2$NAME,maxDist=6)]
data$Date<-as.Date(data$Date)
data$region[is.na(data$region)]="unspecified"
data %>%
  group_by(region) %>%
  summarize(cases = sum(Type=="N"), deaths = sum(Type == "D")) -> cases_by_region


deaths<-filter(data,Type=="D")
cases<-filter(data,Type=="N")

cases_by_date <- as.data.frame(xtabs( ~ Date+region , cases))
cases_by_date$Date<-as.Date(cases_by_date$Date)
cases_by_date%>%rename(cases=Freq)%>%
  group_by(region)%>%
  mutate(cum.sum=cumsum(cases))%>% #compute cumulative number of cases per region
  mutate(mov.avg=rollmeanr(cases,7,fill="extend"))->cases_by_date #compute 7 day moving average per region

deaths$Age<-as.numeric(deaths$Age)
deaths_by_date<-as.data.frame(xtabs( ~ Date+region , deaths))
deaths_by_date$Date<-as.Date(deaths_by_date$Date)
deaths_by_date%>%
  rename(deaths=Freq)%>%
  group_by(region)%>%
  mutate(deaths.cum.sum=cumsum(deaths))->deaths_by_date

#IRD for infected (new cases), Recovered (R) and Removed (D)
IRD<-as.data.frame(xtabs( ~ data$Date+data$Type))
IRD%>%rename("Date"=1,"Type"=2,"n"=3)%>%filter(Type!="S")->IRD
IRD$Date<-as.Date(IRD$Date)

IRD%>%
  arrange(Date)%>%
  dplyr::group_by(Type)%>%
  mutate(Type.cum.sum=cumsum(n))->IRD

##testing
test %>%select("Date"=Date,"Cum.cases"=Cum.cases,"New.cases"=new.cases, "Total.tests"=Global.total.test)%>%arrange(Date)->test

Diff.previous<-data.frame("Date"=test$Date[c(2:length(test$Total.tests))],
                          "tests.diff"=diff(test$Total.tests, lag = 1,na.rm=T),
                          "time.diff"=as.integer(diff.Date(test$Date)))%>%
  filter(!is.na(tests.diff)&time.diff==1)#table of daily test (when  there is exactly 1 day between two available "numbers of tests")

data%>%
  group_by(Date)%>%
  summarise(n.cases=sum(Type=="N"),n.deaths=sum(Type=="D"))%>%
  arrange(Date)%>%
  mutate(cum.cases=cumsum(n.cases),mov.avg=rollmeanr(n.cases,7,fill="extend"),
         cum.deaths=cumsum(n.deaths),d.mov.avg=rollmeanr(n.deaths,7,fill="extend"))%>%
  right_join(mutate(test, Date = ymd(Date))) %>%
  left_join(mutate(Diff.previous, Date = ymd(Date))) %>%
  arrange(Date)%>%
  mutate(tests.mov.avg=rollmeanr(tests.diff,5,fill="extend"))%>%
  mutate(positivity=(n.cases/tests.diff)*100)%>%
  mutate(positivity.mov.avg=rollmeanr(positivity,5,fill="extend"))%>%
  select(Date, n.cases, cum.cases, mov.avg, n.deaths, cum.deaths, d.mov.avg, n.tests=tests.diff, cum.tests=Total.tests,
         tests.mov.avg,positivity, positivity.mov.avg)-> ntl.cases


ntl.cases<-ntl.cases[order(ntl.cases$Date,na.last=FALSE),]
ntl.cases$cum.cases<-na.locf(ntl.cases$cum.cases)
ntl.cases$cum.deaths<-na.locf(ntl.cases$cum.deaths)
ntl.cases$Date<-as.Date(ntl.cases$Date)
```

``` {r translation}
#Seting up language for rest of dashboard
#Selecting only the column with the text corresponding to the selected language
c.lang <- params$lang
text <- text %>% select("ref", c.lang)

#Writing a helper function to pull the language specified in params above
f.tr <- function(ref){
  txt <- as.character(text[text$ref == ref, 2])
  return(txt)
}
```

`r format(f.tr("tab_title"))`
========================================================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

```{r sidebar, results='asis', verbatim=TRUE}
date_updated <- format(last(cases$Date),format="%B %d %Y") # any inline stats you need ahead of time!
```

`r format(f.tr("sidebar_part_1"))`

`r format(f.tr("sidebar_part_2"))`

`r format(f.tr("sidebar_part_3"))`

`r format(f.tr("sidebar_part_4"))`

`r paste(f.tr("sidebar_part_5"), date_updated, sep = " ")` 

`r format(f.tr("sidebar_part_6"))`

`r format(f.tr("sidebar_part_7"))`

`r format(f.tr("sidebar_part_8"))`

Row 
-----------------------------------------------------------------------

### Total cases

```{r}
valueBox(value=format(sum(cases_by_date$cases),big.mark = ","),
         caption=paste(f.tr("total_cases_caption"), 
                            format(last(cases_by_date$Date), format="%B %d %Y")),
         icon="fa-ambulance",color="info")
```

### Daily cases

```{r}
valueBox(value=format(last(ntl.cases$mov.avg),big.mark = ",",digits=3),
         caption=paste(f.tr("daily_new_cases_caption")),
         icon="fa-chart-line", color="danger")
```

### Recovered cases
```{r}
IRD%>%filter(Type=="R")->recov
valueBox(value=format(last(recov$Type.cum.sum),big.mark = ","),
         caption=paste(f.tr("total_recovered_caption"), format(last(cases_by_date$Date), format(last(recov$Date), format="%B %d %Y"))),
         icon="fa-check-circle", color="success")
```

### Total deaths
```{r}
valueBox(value=sum(cases_by_region$deaths,na.rm=TRUE), 
         caption=paste(f.tr("total_deaths_caption_a")), 
         color="danger", icon="fa-heartbeat", href="### Total deaths")
```


### Total tests performed: How many tests did Madagascar so far?
```{r}
valueBox(value=format(last(test$Total.tests),big.mark = ","),
         caption=paste(f.tr("total_tests_caption_a"), format(last(test$Date),format= "%B %d %Y")),
         icon="fa-flask", color=ifelse(last(test$Total.tests)/27692 < 5,"warning","info")) #hard-coded number?
```


Row
------------------------

### `r format(f.tr("notes_announs_header"))`

`r format(f.tr("notes_announs_part_1"))`

`r format(f.tr("notes_announs_part_2"))`

`r format(f.tr("notes_announs_part_3"))`


Row {data-width=650}
-----------------------------------------------------------------------

### `r format(f.tr("map_of_cases_header"))`

`r format(f.tr("map_of_cases_note"))`

```{r}
mada_regions <- left_join(mdg2, cases_by_region, by = c("NAME" = "region"))

bins <- pretty(cases_by_region$cases,n=12)
pal <- colorBin("YlOrRd", domain = mada_regions$cases)

labels <- sprintf(
      "<strong>%s</strong><br/> Cases: %i <br/> Deaths: %i",
      mada_regions$NAME, mada_regions$cases, mada_regions$deaths
    ) %>% lapply(htmltools::HTML)
    
map <-leaflet()  %>%
  addTiles()%>%
  addPolygons(data = mada_regions,
              color = "black", weight = 0.001, smoothFactor = 0.1,
              fillColor = ~pal(cases),
              fillOpacity = 0.6,
              dashArray = NULL,
              label = labels,
              highlightOptions = highlightOptions(
                    weight = 3,
                    color = "black",
                    dashArray = NULL,
                    fillOpacity = 0.75,
                    bringToFront = TRUE),
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px",
                direction = "auto")) %>%
  addLegend("bottomright", pal = pal, values = bins, title = f.tr("map_of_cases_legend_caption"))
map %>%addProviderTiles(providers$Esri.WorldStreetMap)
```

### `r format(f.tr("COVID_in_mada_header"))`

`r format(f.tr("COVID_in_mada_part_1"))`

`r format(f.tr("COVID_in_mada_part_2"))`

`r format(f.tr("COVID_in_mada_part_3"))`

`r format(f.tr("COVID_in_mada_part_4"))`

`r format(f.tr("COVID_in_mada_part_5"))`

`r paste0(f.tr("COVID_in_mada_part_6")), round(last(na.trim(ntl.cases$tests.mov.avg)), 2)`





